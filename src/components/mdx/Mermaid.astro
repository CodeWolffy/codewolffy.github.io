---
// Mermaid 图表组件
// 支持预览/代码切换、缩放、全屏
interface Props {
    chart: string;
}

const { chart } = Astro.props;
const id = `mermaid-${Math.random().toString(36).substring(2, 9)}`;

// 解码 HTML 实体
function decodeHtmlEntities(str: string): string {
    return str
        .replace(/&#x22;/g, '"')
        .replace(/&#34;/g, '"')
        .replace(/&quot;/g, '"')
        .replace(/&#x27;/g, "'")
        .replace(/&#39;/g, "'")
        .replace(/&apos;/g, "'")
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>')
        .replace(/&amp;/g, '&');
}

const decodedChart = decodeHtmlEntities(chart || '');
---

<div class="mermaid-container my-6" data-mermaid-id={id}>
    <!-- 预览视图工具栏 -->
    <div class="mermaid-toolbar" data-toolbar="preview">
        <!-- 缩小 -->
        <button class="mermaid-btn" data-action="zoom-out" title="缩小">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                <line x1="8" y1="11" x2="14" y2="11"/>
            </svg>
        </button>
        <!-- 放大 -->
        <button class="mermaid-btn" data-action="zoom-in" title="放大">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"/>
                <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                <line x1="11" y1="8" x2="11" y2="14"/>
                <line x1="8" y1="11" x2="14" y2="11"/>
            </svg>
        </button>
        <!-- 全屏 -->
        <button class="mermaid-btn" data-action="fullscreen" title="全屏查看">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M8 3H5a2 2 0 0 0-2 2v3"/><path d="M21 8V5a2 2 0 0 0-2-2h-3"/>
                <path d="M3 16v3a2 2 0 0 0 2 2h3"/><path d="M16 21h3a2 2 0 0 0 2-2v-3"/>
            </svg>
        </button>
        <!-- 查看代码 -->
        <button class="mermaid-btn mermaid-btn-text" data-action="show-code" title="查看代码">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="16 18 22 12 16 6"/>
                <polyline points="8 6 2 12 8 18"/>
            </svg>
            <span>查看代码</span>
        </button>
    </div>
    
    <!-- 代码视图工具栏 -->
    <div class="mermaid-toolbar" data-toolbar="code" style="display: none;">
        <!-- 复制 -->
        <button class="mermaid-btn" data-action="copy" title="复制代码">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
            </svg>
        </button>
        <!-- 预览 -->
        <button class="mermaid-btn mermaid-btn-text" data-action="show-preview" title="预览">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
            <span>预览</span>
        </button>
    </div>
    
    <!-- 预览视图（默认显示） -->
    <div class="mermaid-preview-view" data-view="preview">
        <div class="mermaid-scroll-container" data-draggable>
            <div class="mermaid-content" data-zoom="1">
                <pre id={id} class="mermaid" data-chart={decodedChart}></pre>
            </div>
        </div>
    </div>
    
    <!-- 代码视图（默认隐藏） -->
    <div class="mermaid-code-view" data-view="code" style="display: none;">
        <pre><code class="language-mermaid">{decodedChart}</code></pre>
    </div>
</div>

<!-- 全屏模态框 -->
<div class="mermaid-modal" data-modal-for={id}>
    <div class="mermaid-modal-content">
        <div class="mermaid-modal-toolbar">
            <button class="mermaid-btn" data-action="modal-zoom-out" title="缩小">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    <line x1="8" y1="11" x2="14" y2="11"/>
                </svg>
            </button>
            <span class="mermaid-zoom-label" data-zoom-label>100%</span>
            <button class="mermaid-btn" data-action="modal-zoom-in" title="放大">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"/>
                    <line x1="21" y1="21" x2="16.65" y2="16.65"/>
                    <line x1="11" y1="8" x2="11" y2="14"/>
                    <line x1="8" y1="11" x2="14" y2="11"/>
                </svg>
            </button>
            <button class="mermaid-btn" data-action="modal-reset" title="重置缩放">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                    <path d="M3 3v5h5"/>
                </svg>
            </button>
            <button class="mermaid-modal-close" data-action="close-modal" title="关闭">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                </svg>
            </button>
        </div>
        <div class="mermaid-modal-scroll" data-draggable>
            <div class="mermaid-modal-chart" data-zoom="1"></div>
        </div>
    </div>
</div>

<script>
    import mermaid from 'mermaid';
    
    let isInitializing = false;
    
    const initMermaid = async () => {
        if (isInitializing) return;
        isInitializing = true;
        
        try {
            const isDark = document.documentElement.classList.contains('dark');
            
            mermaid.initialize({
                startOnLoad: false,
                theme: isDark ? 'dark' : 'default',
                securityLevel: 'loose',
                fontFamily: 'inherit',
                maxTextSize: 100000,
                er: { useMaxWidth: false, minEntityWidth: 100, minEntityHeight: 75 },
                flowchart: { useMaxWidth: false, htmlLabels: true },
            });
            
            // 渲染所有图表
            const elements = document.querySelectorAll('.mermaid:not([data-processed])');
            for (const element of elements) {
                await renderMermaid(element);
            }
            
            initToolbar();
            initDraggable();
        } finally {
            isInitializing = false;
        }
    };
    
    // 渲染单个 mermaid 图表
    const renderMermaid = async (element: Element) => {
        if (element.getAttribute('data-processed')) return;
        
        try {
            const chartData = element.getAttribute('data-chart') || '';
            if (!chartData.trim()) return;
            
            const elemId = element.id || `mermaid-${Math.random().toString(36).substring(2, 9)}`;
            const { svg } = await mermaid.render(elemId + '-svg', chartData);
            element.innerHTML = svg;
            element.setAttribute('data-processed', 'true');
        } catch (error) {
            console.error('Mermaid rendering error:', error);
            element.innerHTML = `<div class="mermaid-error">渲染失败: ${error instanceof Error ? error.message : '未知错误'}</div>`;
            element.setAttribute('data-processed', 'true');
        }
    };
    
    // 拖动功能
    const initDraggable = () => {
        document.querySelectorAll('[data-draggable]:not([data-drag-init])').forEach(container => {
            container.setAttribute('data-drag-init', 'true');
            
            let isDragging = false;
            let startX = 0, startY = 0;
            let scrollLeft = 0, scrollTop = 0;
            
            container.addEventListener('mousedown', (e: Event) => {
                const event = e as MouseEvent;
                if ((event.target as HTMLElement).closest('button')) return;
                isDragging = true;
                (container as HTMLElement).style.cursor = 'grabbing';
                startX = event.pageX - (container as HTMLElement).offsetLeft;
                startY = event.pageY - (container as HTMLElement).offsetTop;
                scrollLeft = (container as HTMLElement).scrollLeft;
                scrollTop = (container as HTMLElement).scrollTop;
            });
            
            container.addEventListener('mouseleave', () => {
                isDragging = false;
                (container as HTMLElement).style.cursor = 'grab';
            });
            
            container.addEventListener('mouseup', () => {
                isDragging = false;
                (container as HTMLElement).style.cursor = 'grab';
            });
            
            container.addEventListener('mousemove', (e: Event) => {
                if (!isDragging) return;
                e.preventDefault();
                const event = e as MouseEvent;
                const x = event.pageX - (container as HTMLElement).offsetLeft;
                const y = event.pageY - (container as HTMLElement).offsetTop;
                const walkX = (x - startX) * 1.5;
                const walkY = (y - startY) * 1.5;
                (container as HTMLElement).scrollLeft = scrollLeft - walkX;
                (container as HTMLElement).scrollTop = scrollTop - walkY;
            });
        });
    };
    
    // 工具栏功能
    const initToolbar = () => {
        document.querySelectorAll('.mermaid-container:not([data-toolbar-init])').forEach(container => {
            container.setAttribute('data-toolbar-init', 'true');
            const mermaidId = container.getAttribute('data-mermaid-id');
            
            const previewView = container.querySelector('[data-view="preview"]') as HTMLElement;
            const codeView = container.querySelector('[data-view="code"]') as HTMLElement;
            const previewToolbar = container.querySelector('[data-toolbar="preview"]') as HTMLElement;
            const codeToolbar = container.querySelector('[data-toolbar="code"]') as HTMLElement;
            const content = container.querySelector('.mermaid-content') as HTMLElement;
            const mermaidEl = container.querySelector('.mermaid');
            
            const modal = document.querySelector(`.mermaid-modal[data-modal-for="${mermaidId}"]`);
            const modalChart = modal?.querySelector('.mermaid-modal-chart') as HTMLElement;
            const zoomLabel = modal?.querySelector('[data-zoom-label]');
            
            let zoom = 0.75;
            let modalZoom = 1;
            
            const updateZoom = (target: HTMLElement, newZoom: number) => {
                target.style.transform = `scale(${newZoom})`;
                target.style.transformOrigin = 'top left';
            };
            
            // 初始化时应用默认缩放
            if (content) {
                updateZoom(content, zoom);
            }
            
            // 切换视图
            const showPreview = () => {
                previewView.style.display = 'block';
                codeView.style.display = 'none';
                previewToolbar.style.display = 'flex';
                codeToolbar.style.display = 'none';
            };
            
            const showCode = () => {
                previewView.style.display = 'none';
                codeView.style.display = 'block';
                previewToolbar.style.display = 'none';
                codeToolbar.style.display = 'flex';
            };
            
            // 全屏
            const openFullscreen = () => {
                if (modal && mermaidEl && modalChart) {
                    modalChart.innerHTML = mermaidEl.innerHTML;
                    modalZoom = 1;
                    updateZoom(modalChart, 1);
                    if (zoomLabel) zoomLabel.textContent = '100%';
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    initDraggable();
                }
            };
            
            const closeFullscreen = () => {
                modal?.classList.remove('active');
                document.body.style.overflow = '';
            };
            
            // 绑定按钮事件
            container.querySelectorAll('.mermaid-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const action = (btn as HTMLElement).getAttribute('data-action');
                    
                    switch (action) {
                        case 'zoom-in':
                            zoom = Math.min(zoom + 0.25, 3);
                            updateZoom(content, zoom);
                            break;
                        case 'zoom-out':
                            zoom = Math.max(zoom - 0.25, 0.25);
                            updateZoom(content, zoom);
                            break;
                        case 'fullscreen':
                            openFullscreen();
                            break;
                        case 'show-code':
                            showCode();
                            break;
                        case 'show-preview':
                            showPreview();
                            break;
                        case 'copy':
                            const code = mermaidEl?.getAttribute('data-chart') || '';
                            try {
                                await navigator.clipboard.writeText(code);
                                showToast('代码已复制到剪贴板');
                            } catch (err) {
                                showToast('复制失败');
                            }
                            break;
                    }
                });
            });
            
            // 模态框按钮
            modal?.querySelectorAll('.mermaid-btn, .mermaid-modal-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = (btn as HTMLElement).getAttribute('data-action');
                    
                    switch (action) {
                        case 'modal-zoom-in':
                            modalZoom = Math.min(modalZoom + 0.25, 5);
                            updateZoom(modalChart, modalZoom);
                            if (zoomLabel) zoomLabel.textContent = `${Math.round(modalZoom * 100)}%`;
                            break;
                        case 'modal-zoom-out':
                            modalZoom = Math.max(modalZoom - 0.25, 0.25);
                            updateZoom(modalChart, modalZoom);
                            if (zoomLabel) zoomLabel.textContent = `${Math.round(modalZoom * 100)}%`;
                            break;
                        case 'modal-reset':
                            modalZoom = 1;
                            updateZoom(modalChart, modalZoom);
                            if (zoomLabel) zoomLabel.textContent = '100%';
                            break;
                        case 'close-modal':
                            closeFullscreen();
                            break;
                    }
                });
            });
        });
        
        // ESC 关闭模态框
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.mermaid-modal.active').forEach(modal => {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                });
            }
        });
    };
    
    // 显示提示
    const showToast = (message: string) => {
        const existing = document.querySelector('.mermaid-toast');
        if (existing) existing.remove();
        
        const toast = document.createElement('div');
        toast.className = 'mermaid-toast';
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 2000);
    };
    
    if (document.readyState === 'complete') {
        initMermaid();
    } else {
        window.addEventListener('load', initMermaid);
    }
    
    document.addEventListener('astro:page-load', initMermaid);
    
    let themeTimeout: ReturnType<typeof setTimeout> | null = null;
    const observer = new MutationObserver((mutations) => {
        if (mutations.some(m => m.attributeName === 'class')) {
            if (themeTimeout) clearTimeout(themeTimeout);
            themeTimeout = setTimeout(() => {
                document.querySelectorAll('.mermaid[data-processed]').forEach(el => {
                    el.removeAttribute('data-processed');
                    el.innerHTML = '';
                });
                document.querySelectorAll('[data-drag-init]').forEach(el => {
                    el.removeAttribute('data-drag-init');
                });
                document.querySelectorAll('[data-toolbar-init]').forEach(el => {
                    el.removeAttribute('data-toolbar-init');
                });
                initMermaid();
            }, 100);
        }
    });
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
</script>

<style is:global>
    .mermaid-container {
        position: relative;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        background: #f8fafc;
        overflow: hidden;
    }
    
    .dark .mermaid-container {
        background: #1e293b;
        border-color: #334155;
    }
    
    /* 工具栏 - 右上角 */
    .mermaid-toolbar {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        z-index: 10;
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }
    
    /* 工具栏按钮 */
    .mermaid-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 32px;
        padding: 0 0.5rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        background: #fff;
        color: #64748b;
        cursor: pointer;
        transition: all 0.15s ease;
    }
    
    .mermaid-btn:hover {
        background: #f1f5f9;
        color: #334155;
        border-color: #cbd5e1;
    }
    
    .dark .mermaid-btn {
        background: #334155;
        border-color: #475569;
        color: #94a3b8;
    }
    
    .dark .mermaid-btn:hover {
        background: #475569;
        color: #e2e8f0;
    }
    
    /* 带文字的按钮 */
    .mermaid-btn-text {
        gap: 0.375rem;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    /* 预览视图 */
    .mermaid-preview-view {
        background: #fff;
    }
    
    .dark .mermaid-preview-view {
        background: #1e293b;
    }
    
    .mermaid-scroll-container {
        max-height: 500px;
        overflow: auto;
        cursor: grab;
        user-select: none;
    }
    
    .mermaid-scroll-container:active {
        cursor: grabbing;
    }
    
    .mermaid-content {
        display: inline-block;
        padding: 1rem;
        padding-top: 3rem;
    }
    
    .mermaid {
        display: block;
        background: transparent !important;
    }
    
    .mermaid svg {
        display: block;
        max-width: none !important;
        height: auto !important;
        width: auto !important;
    }
    
    .mermaid-error {
        color: #ef4444;
        padding: 1rem;
        font-size: 0.875rem;
    }
    
    /* 代码视图 */
    .mermaid-code-view {
        padding: 1rem;
        padding-top: 3rem;
        padding-right: 6rem;
        overflow: auto;
        max-height: 400px;
    }
    
    .mermaid-code-view pre {
        margin: 0;
        background: transparent;
    }
    
    .mermaid-code-view code {
        font-family: 'Fira Code', 'Monaco', 'Consolas', monospace;
        font-size: 0.875rem;
        line-height: 1.7;
        color: #334155;
        white-space: pre;
        tab-size: 4;
    }
    
    .dark .mermaid-code-view code {
        color: #e2e8f0;
    }
    
    /* 全屏模态框 */
    .mermaid-modal {
        display: none;
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(4px);
    }
    
    .mermaid-modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .mermaid-modal-content {
        position: relative;
        width: 95vw;
        height: 95vh;
        background: #fff;
        border-radius: 0.75rem;
        overflow: hidden;
    }
    
    .dark .mermaid-modal-content {
        background: #1e293b;
    }
    
    .mermaid-modal-toolbar {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        z-index: 10;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.35rem;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(8px);
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    .dark .mermaid-modal-toolbar {
        background: rgba(30, 41, 59, 0.95);
        border-color: #475569;
    }
    
    .mermaid-zoom-label {
        font-size: 0.75rem;
        font-weight: 500;
        color: #64748b;
        min-width: 3rem;
        text-align: center;
    }
    
    .dark .mermaid-zoom-label {
        color: #94a3b8;
    }
    
    .mermaid-modal-close {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        padding: 0;
        border: none;
        border-radius: 0.375rem;
        background: transparent;
        color: #64748b;
        cursor: pointer;
        transition: all 0.15s ease;
        margin-left: 0.25rem;
        border-left: 1px solid #e2e8f0;
    }
    
    .mermaid-modal-close:hover {
        background: #fee2e2;
        color: #ef4444;
    }
    
    .dark .mermaid-modal-close {
        color: #94a3b8;
        border-left-color: #475569;
    }
    
    .dark .mermaid-modal-close:hover {
        background: rgba(239, 68, 68, 0.2);
        color: #f87171;
    }
    
    .mermaid-modal-scroll {
        width: 100%;
        height: 100%;
        overflow: auto;
        padding: 2rem;
        cursor: grab;
        user-select: none;
    }
    
    .mermaid-modal-scroll:active {
        cursor: grabbing;
    }
    
    .mermaid-modal-chart {
        display: inline-block;
    }
    
    .mermaid-modal-chart svg {
        max-width: none !important;
        height: auto !important;
    }
    
    /* Toast 提示 */
    .mermaid-toast {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        padding: 0.75rem 1.5rem;
        background: #1e293b;
        color: #fff;
        font-size: 0.875rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 10000;
    }
    
    .mermaid-toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
    
    .dark .mermaid-toast {
        background: #334155;
    }
</style>
