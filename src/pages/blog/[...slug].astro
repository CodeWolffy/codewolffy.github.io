---
import { type CollectionEntry, getCollection, render } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import { TableOfContents } from '@/components/blog/TableOfContents';
import { Comments } from '@/components/blog/Comments';
import { BackButton } from '@/components/ui/BackButton';
import { CopyCodeButton } from '@/components/blog/CopyCodeButton';
import { ShareButtons } from '@/components/blog/ShareButtons';
import { ExportButton } from '@/components/blog/ExportButton';
import { Breadcrumbs } from '@/components/ui/Breadcrumbs';
import { Copyright } from '@/components/blog/Copyright';
import { buttonVariants } from '@/components/ui/button';
import { FilePenLine } from 'lucide-react';
import Callout from '../../components/mdx/Callout.astro';
import Mermaid from '../../components/mdx/Mermaid.astro';
import Iframe from '../../components/mdx/Iframe.astro';
import { calculateReadingTime } from '../../utils/reading-time';


export const prerender = true;

export async function getStaticPaths() {
	const posts = await getCollection('blog', ({ data }) => {
		return import.meta.env.PROD ? data.draft !== true : true;
	});
	return posts.map((post) => ({
		params: { slug: post.slug },
		props: { post, allPosts: posts },
	}));
}

interface Props {
	post: CollectionEntry<'blog'>;
	allPosts: CollectionEntry<'blog'>[];
}

const { post, allPosts } = Astro.props;
const { Content, headings } = await render(post);


// Resolve Category
const allCategories = await getCollection('categories');
const categoryMap = new Map(allCategories.map(c => [c.id, c.data.name]));
const categoryId = post.data.category;
const categoryName = categoryId ? (categoryMap.get(categoryId) || categoryId) : null;

// Resolve Tags
const allTags = await getCollection('tags');
const tagMap = new Map(allTags.map(t => [t.id, t.data.name]));
const tagIds = post.data.tags || [];
const tagNames = tagIds.map(tagId => tagMap.get(tagId) || tagId); // Used for SEO

// è®¡ç®—é˜…è¯»æ—¶é—´ï¼ˆç²¾ç»†åŒ–è®¡ç®—ï¼šè€ƒè™‘å›¾ç‰‡ã€ä»£ç ã€Mermaidç­‰ï¼‰
const content = post.body || '';
const readingTimeResult = calculateReadingTime(content);
const wordCount = readingTimeResult.wordCount;
const readingTime = readingTimeResult.minutes;

// è·å–ç›¸å…³æ–‡ç« ï¼ˆæ™ºèƒ½æ¨èç®—æ³•ï¼‰
const relatedPosts = allPosts
	.filter(p => p.slug !== post.slug) // æ’é™¤å½“å‰æ–‡ç« 
	.map(p => {
		let score = 0;
		const pTags = p.data.tags || [];
		const pCategory = p.data.category;

		// æ ‡ç­¾åŒ¹é…å¾—åˆ†ï¼šæ¯ä¸ªå…±åŒæ ‡ç­¾ +1 åˆ†
		const sharedTags = pTags.filter(tag => tagIds.includes(tag));
		score += sharedTags.length;

		// åˆ†ç±»åŒ¹é…å¾—åˆ†ï¼šåŒåˆ†ç±» +1 åˆ† (ä½œä¸ºè¾…åŠ©åŠ æƒ)
		if (categoryId && pCategory && categoryId === pCategory) {
			score += 1;
		}

		return {
			post: p,
			score: score
		};
	})
	.filter(item => item.score > 0) // åªä¿ç•™è‡³å°‘æœ‰ä¸€ç‚¹ç›¸å…³æ€§çš„æ–‡ç« 
	.sort((a, b) => {
		// ä¼˜å…ˆæŒ‰åˆ†æ•°é™åºæ’åº
		if (b.score !== a.score) {
			return b.score - a.score;
		}
		// åˆ†æ•°ç›¸åŒï¼ŒæŒ‰å‘å¸ƒæ—¶é—´é™åºæ’åºï¼ˆæ–°çš„åœ¨å‰ï¼‰
		return b.post.data.pubDate.valueOf() - a.post.data.pubDate.valueOf();
	})
	.map(item => item.post)
	.slice(0, 3);

// è·å–ä¸Šä¸€ç¯‡å’Œä¸‹ä¸€ç¯‡æ–‡ç« 
const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
const currentIndex = sortedPosts.findIndex(p => p.slug === post.slug);
const prevPost = currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;
const nextPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;

// å½“å‰é¡µé¢ URL
const pageUrl = Astro.url.href;
---

<BaseLayout 
	title={post.data.title} 
	description={post.data.description}
	image={post.data.coverImage || post.data.heroImage}
	type="article"
	publishedTime={post.data.pubDate}
	modifiedTime={post.data.updatedDate}
	author="ç‹¼ç çºª"
>
	<!-- JSON-LD ç»“æ„åŒ–æ•°æ® -->
	<script type="application/ld+json" set:html={JSON.stringify({
		"@context": "https://schema.org",
		"@type": "BlogPosting",
		"headline": post.data.title,
		"description": post.data.description,
		"datePublished": post.data.pubDate.toISOString(),
		"dateModified": post.data.updatedDate?.toISOString() || post.data.pubDate.toISOString(),
		"author": {
			"@type": "Person",
			"name": "ç‹¼ç çºª",
			"url": Astro.site?.href
		},
		"publisher": {
			"@type": "Organization",
			"name": "ç‹¼ç çºª",
			"url": Astro.site?.href
		},
		"mainEntityOfPage": {
			"@type": "WebPage",
			"@id": pageUrl
		},
		"image": post.data.coverImage || post.data.heroImage || "/og-image.jpg",
		"keywords": tagNames.join(", "),
		"articleSection": categoryName || "æŠ€æœ¯æ–‡ç« ",
		"wordCount": wordCount,
		"timeRequired": `PT${readingTime}M`
	})} />
	<div class="container mx-auto pt-2 pb-4 lg:pt-4 lg:pb-6 relative lg:gap-8 lg:grid lg:grid-cols-[1fr_330px]">
        <div class="w-full min-w-0">
            <div class="mb-1">
                <Breadcrumbs 
                    items={[
                         ...(categoryName ? [{ label: categoryName, href: `/categories/${categoryId}` }] : [])
                    ]} 
                />
            </div>

                <h1 class="scroll-m-20 text-4xl font-extrabold tracking-tight lg:text-5xl mb-1">
                    {post.data.title}
                </h1>
                <div class="flex flex-wrap items-center gap-x-4 gap-y-2 text-base text-muted-foreground mb-1">

                    {post.data.pubDate && (
                        <time datetime={post.data.pubDate.toISOString()}>
                            å‘å¸ƒäº {post.data.pubDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })}
                        </time>
                    )}
                    {post.data.updatedDate && (
                        <time datetime={post.data.updatedDate.toISOString()}>
                            æ›´æ–°äº {post.data.updatedDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })}
                        </time>
                    )}
                    <!-- é˜…è¯»æ—¶é—´ -->
                    <span class="inline-flex items-center gap-1.5">
                        <svg class="size-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        çº¦ {readingTime} åˆ†é’Ÿ
                    </span>
                    <!-- é˜…è¯»é‡ - ä¸è’œå­ (ä¼˜åŒ–ï¼šåŠ è½½ä¸­æ˜¾ç¤ºéª¨æ¶) -->
                    <span class="inline-flex items-center gap-1.5 busuanzi-loading" id="busuanzi_container_page_pv">
                        <svg class="size-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                        <span id="busuanzi_value_page_pv" class="min-w-[1.5rem] text-center">...</span>æ¬¡æµè§ˆ
                    </span>
                </div>
                {tagIds.length > 0 && (
                    <div class="mb-1 flex flex-wrap items-center gap-2">
                        <span class="text-base text-muted-foreground">æ ‡ç­¾ï¼š</span>
                        {tagIds.map((tagId) => (
                            <a href={`/tags/${tagId}`} class="text-base font-medium text-primary hover:underline">
                                #{tagMap.get(tagId) || tagId}
                            </a>
                        ))}
                    </div>
                )}
                <div class="lg:hidden mb-1 px-4 bg-secondary rounded-xl sticky top-11 md:top-14 z-[60] border border-border/50 w-full">
                    <TableOfContents headings={headings} client:load />
                </div>
                {(post.data.coverImage || post.data.heroImage) && (
                    <img
                        src={post.data.coverImage || post.data.heroImage}
                        alt={post.data.title}
                        width={720}
                        height={405}
                        class="mb-4 rounded-md border bg-muted transition-colors w-auto max-w-full max-h-[650px] mx-auto cursor-zoom-in cover-image"
                    />
                )}


            <div class="prose dark:prose-invert max-w-none" data-pagefind-body>
                <Content components={{ Callout, Mermaid, Iframe }} />
            </div>
			
			<!-- ä»£ç å¤åˆ¶æŒ‰é’®åˆå§‹åŒ– -->
			<CopyCodeButton client:load />
			
			<!-- åˆ†äº«ä¸å¯¼å‡ºæŒ‰é’® -->
			<div class="mt-2 pt-2 border-t border-border flex flex-wrap items-center justify-between gap-4">
				<ShareButtons title={post.data.title} description={post.data.description} url={pageUrl} client:load />
				<div class="flex gap-2 w-full lg:w-auto">
					<a
						href={`https://codewolffy.pages.dev/keystatic/branch/main/collection/posts/item/${post.slug}`}
						target="_blank"
						rel="noopener noreferrer"
						class={buttonVariants({ variant: "outline", size: "sm" }) + " gap-2 flex-1 lg:flex-none justify-center"}
					>
						<FilePenLine className="h-4 w-4" />
						ç¼–è¾‘æ­¤é¡µ
					</a>
					<ExportButton title={post.data.title} content={post.body || ''} frontmatter={post.data} className="flex-1 lg:flex-none" client:load />
				</div>
			</div>
			
			<!-- ä¸Šä¸€ç¯‡/ä¸‹ä¸€ç¯‡å¯¼èˆª -->
			{(prevPost || nextPost) && (
				<div class="mt-2 grid gap-4 sm:grid-cols-2">
					{prevPost ? (
						<a 
							href={`/blog/${prevPost.slug}`}
							class="group flex flex-col p-2 rounded-xl border border-border hover:border-primary/50 hover:bg-secondary/50 transition-all"
						>
							<span class="text-xs text-muted-foreground mb-1 flex items-center gap-1">
								<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:-translate-x-1 transition-transform"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
								ä¸Šä¸€ç¯‡
							</span>
							<span class="font-medium group-hover:text-primary transition-colors line-clamp-1">{prevPost.data.title}</span>
						</a>
					) : <div />}
					{nextPost ? (
						<a 
							href={`/blog/${nextPost.slug}`}
							class="group flex flex-col p-2 rounded-xl border border-border hover:border-primary/50 hover:bg-secondary/50 transition-all text-right"
						>
							<span class="text-xs text-muted-foreground mb-1 flex items-center justify-end gap-1">
								ä¸‹ä¸€ç¯‡
								<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="group-hover:translate-x-1 transition-transform"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
							</span>
							<span class="font-medium group-hover:text-primary transition-colors line-clamp-1">{nextPost.data.title}</span>
						</a>
					) : <div />}
				</div>
			)}
			
			<!-- ç›¸å…³æ–‡ç« æ¨è -->
			{relatedPosts.length > 0 && (
				<div class="mt-2">
					<h3 class="text-lg font-bold mb-2 flex items-center gap-2">
						<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
						ç›¸å…³æ–‡ç« 
					</h3>
					<div class="grid gap-1">
						{relatedPosts.map((relatedPost) => (
							<a 
								href={`/blog/${relatedPost.slug}`}
								class="group flex rounded-lg border border-border hover:border-primary/50 hover:bg-secondary/30 transition-all overflow-hidden"
							>
								{(relatedPost.data.coverImage || relatedPost.data.heroImage) && (
									<img 
										src={relatedPost.data.coverImage || relatedPost.data.heroImage}
										alt={relatedPost.data.title}
										class="w-32 aspect-video object-cover shrink-0"
									/>
								)}
								<div class="min-w-0 p-3 flex flex-col justify-center">
									<h4 class="font-bold text-sm group-hover:text-primary transition-colors line-clamp-1 mb-1">
										{relatedPost.data.title}
									</h4>
									<p class="text-xs text-muted-foreground line-clamp-2">
										{relatedPost.data.description}
									</p>
								</div>
							</a>
						))}
					</div>
				</div>
			)}
			
            <Copyright title={post.data.title} url={pageUrl} />


            <hr class="mt-2" />
            <Comments client:load />
        </div>

        <script>
            import mediumZoom from 'medium-zoom';
            
            // Function to initialize zoom and lightbox
            const initZoom = () => {
                // Initialize medium-zoom for article images ONLY
                mediumZoom('.prose img', {
                    margin: 24,
                    background: 'rgba(0,0,0,0.8)',
                    scrollOffset: 0,
                });

                // Custom Lightbox for Cover Image
                const coverImage = document.querySelector('.cover-image') as HTMLImageElement;
                if (coverImage) {
                    // Remove any existing listeners to prevent duplicates on view transitions
                    const newCoverImage = coverImage.cloneNode(true) as HTMLImageElement;
                    if (coverImage.parentNode) {
                        coverImage.parentNode.replaceChild(newCoverImage, coverImage);
                    }
                    
                    newCoverImage.addEventListener('click', () => {
                        // Create overlay
                        const overlay = document.createElement('div');
                        overlay.style.cssText = `
                            position: fixed;
                            top: 0; left: 0; width: 100vw; height: 100vh;
                            background: rgba(0,0,0,0.9);
                            z-index: 99999;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            cursor: zoom-out;
                            opacity: 0;
                            transition: opacity 0.3s;
                        `;
                        
                        const img = document.createElement('img');
                        img.src = newCoverImage.src;
                        img.style.cssText = `
                            width: 100%;
                            height: 100%;
                            max-width: 95vw;
                            max-height: 95vh;
                            object-fit: contain;
                            box-shadow: 0 0 20px rgba(0,0,0,0.5);
                            transform: scale(0.9);
                            transition: transform 0.3s;
                        `;
                        
                        overlay.appendChild(img);
                        document.body.appendChild(overlay);
                        
                        // Prevent scrolling on body, but we need to listen for scroll events to close
                        document.body.style.overflow = 'hidden';
                        
                        // Animate in
                        requestAnimationFrame(() => {
                            overlay.style.opacity = '1';
                            img.style.transform = 'scale(1)';
                        });
                        
                        // Close logic
                        const close = () => {
                            overlay.style.opacity = '0';
                            img.style.transform = 'scale(0.9)';
                            document.body.style.overflow = ''; // Restore scrolling
                            
                            // Remove listeners
                            window.removeEventListener('wheel', onWheel);
                            document.removeEventListener('keydown', onEsc);
                            
                            setTimeout(() => {
                                if (overlay.parentNode) overlay.remove();
                            }, 300);
                        };

                        // Scroll to close
                        const onWheel = () => {
                            close();
                        };
                        window.addEventListener('wheel', onWheel, { passive: true });

                        overlay.onclick = close;
                        
                        // Close on Escape key
                        const onEsc = (e: KeyboardEvent) => {
                            if (e.key === 'Escape') {
                                close();
                            }
                        };
                        document.addEventListener('keydown', onEsc);
                    });
                }
            };

            // Run on initial load
            initZoom();

            // Re-run on View Transitions navigation
            document.addEventListener('astro:page-load', initZoom);
            
            // Handle Video Embeds (Responsive + Captions + Disable Autoplay)
            const initVideos = () => {
                const iframes = document.querySelectorAll('.prose iframe');
                iframes.forEach(oldIframe => {
                    // Check if already processed (æ”¯æŒ rehype æ’ä»¶çš„ video-wrapper å’Œ JS çš„ video-container)
                    const parent = oldIframe.parentElement;
                    if (parent && (parent.classList.contains('video-container') || parent.classList.contains('video-wrapper'))) {
                        // å¦‚æœæ˜¯ video-wrapperï¼Œéœ€è¦æ·»åŠ å¿…è¦çš„å±æ€§ç¡®ä¿å…¨å±å·¥ä½œ
                        if (parent.classList.contains('video-wrapper')) {
                            parent.classList.add('video-container');
                            // æ›´æ–° iframe å±æ€§
                            oldIframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen; presentation');
                            oldIframe.setAttribute('allowfullscreen', 'true');
                            oldIframe.setAttribute('webkitallowfullscreen', 'true');
                            oldIframe.setAttribute('mozallowfullscreen', 'true');
                            oldIframe.removeAttribute('sandbox');
                            
                            // Bç«™ç§»åŠ¨ç«¯æ’­æ”¾å™¨æ›¿æ¢ + ç¦ç”¨è‡ªåŠ¨æ’­æ”¾
                            let src = oldIframe.getAttribute('src') || '';
                            if (src.includes('bilibili.com')) {
                                // å¤„ç†åè®®
                                if (src.startsWith('//')) src = 'https:' + src;
                                
                                // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
                                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                                
                                // ç§»åŠ¨ç«¯æ’­æ”¾å™¨æ›¿æ¢ - è§£å†³ç§»åŠ¨ç«¯å…¨å±é—®é¢˜
                                if (isMobile && src.includes('player.bilibili.com/player.html')) {
                                    src = src.replace('player.bilibili.com/player.html', 'www.bilibili.com/blackboard/html5mobileplayer.html');
                                }
                                
                                // ç¡®ä¿ autoplay=0 å’Œå…¶ä»–ç¦ç”¨è‡ªåŠ¨æ’­æ”¾å‚æ•°
                                if (!src.includes('autoplay=')) {
                                    src += (src.includes('?') ? '&' : '?') + 'autoplay=0';
                                } else if (src.includes('autoplay=1')) {
                                    src = src.replace('autoplay=1', 'autoplay=0');
                                }
                                
                                // æ·»åŠ é¢å¤–å‚æ•°ç¡®ä¿ä¸è‡ªåŠ¨æ’­æ”¾
                                if (!src.includes('as_wide=')) src += '&as_wide=1';
                                if (!src.includes('high_quality=')) src += '&high_quality=1';
                                if (!src.includes('danmaku=')) src += '&danmaku=0';
                                
                                oldIframe.setAttribute('src', src);
                            }
                        }
                        return;
                    }

                    // Create new Iframe (Cloning/Rebuilding ensures attributes apply correctly from start)
                    const newIframe = document.createElement('iframe');
                    
                    // Copy original attributes
                    Array.from(oldIframe.attributes).forEach(attr => {
                        newIframe.setAttribute(attr.name, attr.value);
                    });

                    // Update Src (Autoplay handling + Mobile player)
                    let src = newIframe.getAttribute('src') || '';
                    if (src && (src.includes('bilibili.com') || src.includes('youtube.com'))) {
                         // Handle protocol relative URLs
                         if (src.startsWith('//')) src = 'https:' + src;
                         
                         if (src.includes('bilibili.com')) {
                             // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
                             const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                             
                             // ç§»åŠ¨ç«¯æ’­æ”¾å™¨æ›¿æ¢ - è§£å†³ç§»åŠ¨ç«¯å…¨å±é—®é¢˜
                             if (isMobile && src.includes('player.bilibili.com/player.html')) {
                                 src = src.replace('player.bilibili.com/player.html', 'www.bilibili.com/blackboard/html5mobileplayer.html');
                             }
                             
                             // ç¡®ä¿ autoplay=0 å’Œå…¶ä»–ç¦ç”¨è‡ªåŠ¨æ’­æ”¾å‚æ•°
                             if (!src.includes('autoplay=')) {
                                 src += (src.includes('?') ? '&' : '?') + 'autoplay=0';
                             } else if (src.includes('autoplay=1')) {
                                 src = src.replace('autoplay=1', 'autoplay=0');
                             }
                             
                             // æ·»åŠ é¢å¤–å‚æ•°ç¡®ä¿ä¸è‡ªåŠ¨æ’­æ”¾
                             if (!src.includes('as_wide=')) src += '&as_wide=1';
                             if (!src.includes('high_quality=')) src += '&high_quality=1';
                             if (!src.includes('danmaku=')) src += '&danmaku=0';
                         } else if (src.includes('youtube.com')) {
                             // YouTube ç¦ç”¨è‡ªåŠ¨æ’­æ”¾
                             if (!src.includes('autoplay=')) {
                                 src += (src.includes('?') ? '&' : '?') + 'autoplay=0';
                             } else if (src.includes('autoplay=1')) {
                                 src = src.replace('autoplay=1', 'autoplay=0');
                             }
                         }
                         newIframe.setAttribute('src', src);
                    }

                    // Enforce Fullscreen & Mobile Attributes
                    newIframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen; presentation');
                    newIframe.setAttribute('allowfullscreen', 'true');
                    newIframe.setAttribute('webkitallowfullscreen', 'true');
                    newIframe.setAttribute('mozallowfullscreen', 'true');
                    
                    // ç§»é™¤ sandbox å±æ€§ä»¥ç¡®ä¿ç§»åŠ¨ç«¯å…¨å±åŠŸèƒ½æ­£å¸¸
                    // è§†é¢‘æ¥è‡ªå¯ä¿¡æºï¼ˆBç«™ã€YouTubeï¼‰ï¼Œæ— éœ€ sandbox å®‰å…¨é™åˆ¶
                    newIframe.removeAttribute('sandbox');

                    // iOS specific
                    newIframe.setAttribute('playsinline', 'true');
                    newIframe.setAttribute('webkit-playsinline', 'true');

                    newIframe.style.width = '100%';
                    newIframe.style.height = '100%';
                    newIframe.style.border = '0';
                    newIframe.style.zIndex = '10'; // Ensure it sits on top for touch events
                    newIframe.style.position = 'absolute'; // Reinforce absolute positioning
                    newIframe.style.top = '0';
                    newIframe.style.left = '0';

                    // Create Wrapper
                    const wrapper = document.createElement('figure');
                    wrapper.className = 'my-4';
                    
                    const container = document.createElement('div');
                    container.className = 'video-container';
                    
                    // Assembly: Wrapper -> Container -> NewIframe
                    container.appendChild(newIframe);
                    wrapper.appendChild(container);

                    // Add Caption
                    const title = newIframe.getAttribute('title');
                    if (title) {
                        const caption = document.createElement('figcaption');
                        caption.className = 'text-center text-sm text-muted-foreground mt-2';
                        caption.textContent = title;
                        wrapper.appendChild(caption);
                    }

                    // Add Bilibili Link (Mobile Only)
                    let currentSrc = newIframe.getAttribute('src') || '';
                    if (currentSrc.includes('bilibili.com')) {
                         const match = currentSrc.match(/video\/(BV\w+)/) || currentSrc.match(/bvid=(BV\w+)/);
                         const bvid = match ? match[1] : null;

                         if (bvid) {
                             // Remove bottom margin from container to make it hug the link
                             container.style.marginBottom = '0';
                             container.style.marginTop = '0'; // Ensure it's tight inside the wrapper

                             const link = document.createElement('a');
                             link.href = `https://www.bilibili.com/video/${bvid}`;
                             link.target = "_blank";
                             link.rel = "noopener noreferrer";
                             link.className = "text-xs text-muted-foreground hover:text-primary transition-colors mt-0.5 block text-right lg:hidden";
                             link.textContent = "ğŸ“º å» Bilibili è§‚çœ‹é«˜æ¸…åŸè§†é¢‘ >";
                             wrapper.appendChild(link);
                         }
                    }

                    // Replace Old Iframe
                    oldIframe.parentNode.replaceChild(wrapper, oldIframe);
                });
            };
            
            // Run on load and transitions
            initVideos();
            document.addEventListener('astro:page-load', initVideos);
        </script>
        
        <div class="hidden lg:block">
            <div class="sticky top-24 pl-4 border-l max-h-[calc(100vh-8rem)] overflow-y-auto">
                <TableOfContents headings={headings} client:visible />
            </div>
        </div>
	</div>
</BaseLayout>

<style is:global>
    /* Force Critical Video Styles - æ”¯æŒ video-wrapper å’Œ video-container */
    .video-container,
    .video-wrapper {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%; /* 16:9 */
        height: 0;
        margin: 1.5rem 0;
        border-radius: 0.5rem;
        /* ç§»é™¤ overflow:hidden ä»¥å…è®¸å…¨å±åŠŸèƒ½æ­£å¸¸å·¥ä½œ */
        overflow: visible;
        background: var(--muted);
        /* ç¡®ä¿ç§»åŠ¨ç«¯è§¦æ‘¸äº¤äº’æ­£å¸¸ */
        touch-action: manipulation;
    }

    .video-container iframe,
    .video-wrapper iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
        border: 0;
        border-radius: 0.5rem;
        /* ç¡®ä¿ iframe å¯ä»¥æ¥æ”¶æ‰€æœ‰è§¦æ‘¸äº‹ä»¶ */
        touch-action: auto;
        pointer-events: auto;
    }
</style>
