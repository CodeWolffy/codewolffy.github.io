---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const allPosts = await getCollection("blog");
const categories = await getCollection('categories');
const tags = await getCollection('tags');
const pageTitle = "分类与标签";

// Calculate Categories
const categoryMap = new Map(categories.map(c => [c.id, c.data.name]));
const categoryCounts: Record<string, { id: string, name: string, count: number }> = {};
allPosts.forEach(post => {
    if (post.data.category) {
        const catId = post.data.category;
        const catName = categoryMap.get(catId) || catId;
        if (!categoryCounts[catId]) {
            categoryCounts[catId] = { id: catId, name: catName, count: 0 };
        }
        categoryCounts[catId].count++;
    }
});
const sortedCategories = Object.values(categoryCounts).sort((a, b) => b.count - a.count);

// Calculate Tags
const tagMap = new Map(tags.map(t => [t.id, t.data.name]));
const tagCounts: Record<string, { id: string, name: string, count: number }> = {};
allPosts.forEach(post => {
    if (post.data.tags) {
        post.data.tags.forEach(tagId => {
            const tagName = tagMap.get(tagId) || tagId;
            if (!tagCounts[tagId]) {
                tagCounts[tagId] = { id: tagId, name: tagName, count: 0 };
            }
            tagCounts[tagId].count++;
        });
    }
});
const sortedTags = Object.values(tagCounts).sort((a, b) => b.count - a.count);
---

<BaseLayout title={pageTitle}>
    <div class="container mx-auto max-w-4xl py-6 lg:py-10">
        <div class="flex flex-col items-start gap-4 md:flex-row md:justify-between md:gap-8">
            <div class="flex-1 space-y-4">
                <h1 class="inline-block font-bold text-4xl tracking-tight lg:text-5xl">
                    分类与标签
                </h1>
                <p class="text-xl text-muted-foreground">
                    浏览所有的分类与标签
                </p>
            </div>
        </div>
        
        <hr class="my-8" />
        
        <div class="space-y-16">
            <!-- 分类区域 -->
            <section>
                <div class="flex items-center gap-3 mb-8">
                    <div class="h-8 w-1.5 bg-primary rounded-full"></div>
                    <h2 class="text-2xl font-bold tracking-tight">文章分类</h2>
                </div>
                
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {sortedCategories.length === 0 ? (
                    <p class="text-muted-foreground">暂无分类。</p>
                ) : (
                    sortedCategories.map((category, index) => (
                        <a
                            href={`/categories/${category.id}`}
                            class="group relative flex flex-col justify-between space-y-2 rounded-xl border bg-card p-6 shadow-sm hover:shadow-md hover:border-primary/50 transition-all duration-300 animate-slide-up opacity-0"
                            style={`animation-delay: ${index * 100}ms;`}
                        >
                            <div class="flex items-center justify-between">
                                <h3 class="font-semibold text-xl group-hover:text-primary transition-colors">
                                    {category.name}
                                </h3>
                                <span class="text-xs font-medium bg-secondary text-secondary-foreground px-2 py-1 rounded-md group-hover:bg-primary/10 group-hover:text-primary transition-colors">
                                    {category.count} 篇
                                </span>
                            </div>
                            <p class="text-sm text-muted-foreground group-hover:text-muted-foreground/80">
                                查看所有 "{category.name}" 相关的文章
                            </p>
                        </a>
                    ))
                )}
            </div>
            </section>

             <!-- 标签区域 -->
             <section>
                 <div class="flex items-center gap-3 mb-8">
                    <div class="h-8 w-1.5 bg-secondary-foreground/30 rounded-full"></div>
                    <h2 class="text-2xl font-bold tracking-tight">热门标签</h2>
                 </div>
                 
                 <div class="flex flex-wrap gap-3">
                    {sortedTags.length === 0 ? (
                        <p class="text-muted-foreground">暂无标签。</p>
                    ) : (
                        sortedTags.map((tag, index) => (
                            <a
                                href={`/tags/${tag.id}`}
                                class="group inline-flex items-center gap-2 rounded-full border bg-background px-4 py-2 text-sm font-medium transition-all hover:border-primary hover:text-primary hover:shadow-sm animate-slide-up opacity-0"
                                style={`animation-delay: ${index * 50}ms;`}
                            >
                                <span class="text-muted-foreground group-hover:text-primary/70">#</span>
                                {tag.name}
                                <span class="ml-1 text-xs text-muted-foreground/50 group-hover:text-primary/50">
                                    {tag.count}
                                </span>
                            </a>
                        ))
                    )}
                 </div>
             </section>
        </div>
    </div>
</BaseLayout>
