---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const allPosts = await getCollection("blog", ({ data }) => {
    return import.meta.env.PROD ? data.draft !== true : true;
});
const allTags = await getCollection('tags');

// 计算标签及其文章数量
const tagCounts: Record<string, { name: string, count: number, id: string }> = {};
allTags.forEach(tag => {
    const count = allPosts.filter(post => post.data.tags?.map(t => t.id).includes(tag.id)).length;
    if (count > 0) {
        tagCounts[tag.id] = { name: tag.data.name, count, id: tag.id };
    }
});
const sortedTags = Object.values(tagCounts).sort((a, b) => b.count - a.count);
---

<BaseLayout title="所有标签 | 狼码纪" description="浏览博客的所有标签">
    <div class="container mx-auto max-w-4xl py-8 lg:py-12">
        <!-- 页面标题区域 -->
        <div class="space-y-4 mb-12 text-center">
            <h1 class="inline-block font-bold text-4xl tracking-tight lg:text-5xl text-foreground">
                所有标签
            </h1>
            <p class="text-xl text-muted-foreground">
                共 <span class="font-bold text-foreground">{sortedTags.length}</span> 个标签
            </p>
        </div>
        
        <!-- 标签云 -->
        <div class="flex flex-wrap gap-4 justify-center">
            {sortedTags.map((tag, index) => {
                // 根据文章数量计算标签大小
                const maxCount = sortedTags[0].count;
                const minSize = 0.875; // 最小 text-sm
                const maxSize = 1.5;   // 最大 text-2xl
                const size = minSize + (tag.count / maxCount) * (maxSize - minSize);
                
                return (
                    <a 
                        href={`/tags/${tag.id}`}
                        class="group relative px-5 py-2.5 rounded-full bg-card border border-border/50 hover:border-primary/50 transition-all duration-300 hover:shadow-lg hover:-translate-y-1 overflow-hidden"
                        style={`animation-delay: ${index * 30}ms;`}
                    >
                        <!-- 悬停渐变背景 -->
                        <div class="absolute inset-0 bg-gradient-to-r from-primary/10 to-primary/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                        <span 
                            class="font-medium relative z-10 group-hover:text-primary transition-colors"
                            style={`font-size: ${size}rem;`}
                        >
                            #{tag.name}
                        </span>
                        <span class="ml-2 text-xs text-muted-foreground relative z-10 bg-secondary px-2 py-0.5 rounded-full">
                            {tag.count}
                        </span>
                    </a>
                );
            })}
        </div>
        
        {sortedTags.length === 0 && (
            <div class="text-center py-20 text-muted-foreground">
                <p>暂无标签。</p>
            </div>
        )}
        
        <!-- 返回按钮 -->
        <div class="mt-12 text-center">
            <a 
                href="/categories" 
                class="inline-flex items-center gap-2 text-muted-foreground hover:text-primary transition-colors"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m15 18-6-6 6-6"/>
                </svg>
                返回分类与标签
            </a>
        </div>
    </div>
</BaseLayout>
