---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const allPosts = (await getCollection("blog", ({ data }) => {
    return import.meta.env.PROD ? data.draft !== true : true;
})).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// 获取所有标签
const allTags = await getCollection('tags');
const tagMap = new Map(allTags.map(t => [t.id, t.data.name]));

// 获取所有分类
const allCategories = await getCollection('categories');
const categoryMap = new Map(allCategories.map(c => [c.id, c.data.name]));

// 按年份分组
const postsByYear = allPosts.reduce((acc, post) => {
    const year = post.data.pubDate.getFullYear();
    if (!acc[year]) {
        acc[year] = [];
    }
    acc[year].push(post);
    return acc;
}, {} as Record<number, typeof allPosts>);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));
---

<BaseLayout title="文章归档 | 狼码纪" description="按时间线浏览所有文章">
    <div class="container mx-auto max-w-4xl py-8 lg:py-12">
        <!-- 页面标题区域 -->
        <div class="space-y-4 mb-12 text-center">
            <h1 class="inline-block font-bold text-4xl tracking-tight lg:text-5xl text-foreground">
                文章归档
            </h1>
            <p class="text-xl text-muted-foreground">
                共 <span class="font-bold text-foreground">{allPosts.length}</span> 篇文章
            </p>
        </div>
        
        <div class="relative">
            <!-- 时间线 (Default: Border Color) -->
            <div class="absolute left-4 top-0 bottom-0 w-0.5 md:left-8 bg-border"></div>
            
            {years.map((year, yearIndex) => (
                <div class="mb-8 animate-slide-up opacity-0" style={`animation-delay: ${yearIndex * 150}ms;`}>
                    <!-- 年份标签 -->
                    <div class="relative flex items-center mb-4">
                        <div class="absolute left-0 w-8 h-8 md:w-16 md:h-8 flex items-center justify-center">
                            <!-- 光点 (Default: Primary Color) -->
                            <div class="w-3 h-3 md:w-4 md:h-4 rounded-full z-10 bg-primary shadow-sm"></div>
                            <!-- 横向连接线 (Default: Border Color) -->
                            <div class="absolute left-1/2 top-1/2 h-0.5 w-6 md:w-10 -z-0 bg-border"></div>
                        </div>
                        <!-- 年份标签 -->
                        <div class="ml-10 md:ml-20 px-4 py-1 rounded-full bg-secondary/50 border border-indigo-500/20 backdrop-blur-sm">
                            <h2 class="text-2xl font-bold text-foreground tracking-tight">{year}</h2>
                        </div>
                    </div>
                    
                    <!-- 文章列表 -->
                    <div class="space-y-3 ml-10 md:ml-20">
                        {postsByYear[Number(year)].map((post, postIndex) => (
                            <article 
                                class="group relative rounded-xl hover:shadow-lg transition-all duration-300 bg-card border border-border/60 hover:-translate-y-1 overflow-hidden animate-slide-up opacity-0"
                                style={`animation-delay: ${(yearIndex * 150) + (postIndex * 50)}ms; animation-fill-mode: forwards;`}
                            >
                                <!-- 左侧实色边框 (Blue Accent) -->
                                <div class="absolute left-0 top-0 bottom-0 w-1 opacity-70 group-hover:opacity-100 transition-opacity duration-300 bg-blue-500"></div>
                                
                                <!-- 悬停实色背景 (Default: Muted/Accent) -->
                                <div class="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-muted/50"></div>
                                
                                <a href={`/blog/${post.slug}`} class="block relative z-10 py-2 pr-2 pl-4 sm:py-2.5 sm:pr-2.5 sm:pl-6">
                                    <div class="flex flex-col gap-2">
                                        <!-- Header: Title & Date -->
                                        <div class="flex flex-col sm:flex-row sm:items-baseline sm:justify-between gap-1">
                                            <h3 class="font-bold text-2xl leading-none tracking-tight group-hover:text-primary transition-colors duration-300">
                                                {post.data.title}
                                            </h3>
                                            <time 
                                                datetime={post.data.pubDate.toISOString()}
                                                class="text-sm text-muted-foreground shrink-0 whitespace-nowrap font-medium pt-1"
                                            >
                                                {post.data.pubDate.toLocaleDateString('zh-CN', {
                                                    month: 'long',
                                                    day: 'numeric'
                                                })}
                                            </time>
                                        </div>

                                        <!-- Footer: Metadata (Category & Tags) -->
                                        <div class="flex flex-wrap items-center gap-3 mt-1">
                                            {/* Category */}
                                            {post.data.category && (
                                                <div class="flex items-center gap-1 text-sm font-medium text-primary bg-primary/10 px-2 py-0.5 rounded-md border border-primary/10">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-folder"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg>
                                                    <span>{categoryMap.get(post.data.category) || post.data.category}</span>
                                                </div>
                                            )}
                                            
                                            {/* Tags */}
                                            {post.data.tags && post.data.tags.length > 0 && (
                                                <div class="flex flex-wrap gap-2">
                                                    {post.data.tags.map((tagId) => (
                                                        <span class="flex items-center text-base text-muted-foreground hover:text-foreground transition-colors">
                                                            <span class="opacity-50 mr-0.5">#</span>
                                                            {tagMap.get(tagId) || tagId}
                                                        </span>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </a>
                            </article>
                        ))}
                    </div>
                </div>
            ))}
        </div>
        
        {allPosts.length === 0 && (
            <div class="text-center py-20 text-muted-foreground">
                <p>暂无文章。</p>
            </div>
        )}
    </div>
</BaseLayout>
