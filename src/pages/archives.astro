---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const allPosts = (await getCollection("blog", ({ data }) => {
    return import.meta.env.PROD ? data.draft !== true : true;
})).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// 按年份分组
const postsByYear = allPosts.reduce((acc, post) => {
    const year = post.data.pubDate.getFullYear();
    if (!acc[year]) {
        acc[year] = [];
    }
    acc[year].push(post);
    return acc;
}, {} as Record<number, typeof allPosts>);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));
---

<BaseLayout title="文章归档 | 狼码纪" description="按时间线浏览所有文章">
    <div class="container mx-auto max-w-4xl py-8 lg:py-12">
        <!-- 页面标题区域 -->
        <div class="space-y-4 mb-12 text-center">
            <h1 class="inline-block font-bold text-4xl tracking-tight lg:text-5xl text-foreground">
                文章归档
            </h1>
            <p class="text-xl text-muted-foreground">
                共 <span class="font-bold text-foreground">{allPosts.length}</span> 篇文章
            </p>
        </div>
        
        <div class="relative">
            <!-- 时间线 -->
            <div class="absolute left-4 top-0 bottom-0 w-0.5 md:left-8 bg-primary/20"></div>
            
            {years.map((year, yearIndex) => (
                <div class="mb-12" style={`animation-delay: ${yearIndex * 150}ms;`}>
                    <!-- 年份标签 -->
                    <div class="relative flex items-center mb-6">
                        <div class="absolute left-0 w-8 h-8 md:w-16 md:h-8 flex items-center justify-center">
                            <!-- 光点 -->
                            <div class="w-4 h-4 rounded-full bg-primary shadow-md"></div>
                        </div>
                        <!-- 年份标签 -->
                        <div class="ml-12 md:ml-24 px-4 py-1.5 rounded-full bg-secondary border border-border">
                            <h2 class="text-xl font-bold text-foreground">{year}</h2>
                        </div>
                    </div>
                    
                    <!-- 文章列表 -->
                    <div class="space-y-4 ml-12 md:ml-24">
                        {postsByYear[Number(year)].map((post, postIndex) => (
                            <article 
                                class="group relative rounded-xl p-4 hover:shadow-md transition-all duration-300 bg-card border border-border hover:border-primary/30 border-l-4 border-l-primary overflow-hidden"
                                style={`animation-delay: ${(yearIndex * 150) + (postIndex * 50)}ms;`}
                            >
                                <!-- 悬停背景效果 -->
                                <div class="absolute inset-0 bg-primary/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                                
                                <a href={`/blog/${post.slug}`} class="block relative z-10">
                                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                                        <h3 class="font-semibold text-lg group-hover:text-primary transition-colors duration-300">
                                            {post.data.title}
                                        </h3>
                                        <time 
                                            datetime={post.data.pubDate.toISOString()}
                                            class="text-sm text-muted-foreground shrink-0 px-2 py-0.5 rounded-full bg-secondary/50"
                                        >
                                            {post.data.pubDate.toLocaleDateString('zh-CN', {
                                                month: 'long',
                                                day: 'numeric'
                                            })}
                                        </time>
                                    </div>
                                    {post.data.tags && post.data.tags.length > 0 && (
                                        <div class="flex flex-wrap gap-2 mt-3">
                                            {post.data.tags.map((tag: string) => (
                                                <span class="text-xs px-2.5 py-1 rounded-full bg-secondary text-secondary-foreground font-medium">
                                                    {tag}
                                                </span>
                                            ))}
                                        </div>
                                    )}
                                </a>
                            </article>
                        ))}
                    </div>
                </div>
            ))}
        </div>
        
        {allPosts.length === 0 && (
            <div class="text-center py-20 text-muted-foreground">
                <p>暂无文章。</p>
            </div>
        )}
    </div>
</BaseLayout>
